{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HuMap{% endblock %}</title>

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <link rel="stylesheet" href="{% static 'Componetes/Base/common_layout.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body>

    <div id="notif-box" class="notif-box">
        <p>üöß Rua com buraco ‚Äî Rua Safira</p>
        <p>‚ö†Ô∏è Falta de ilumina√ß√£o ‚Äî Rua Top√°zio</p>
        <p>üö® Assalto recente ‚Äî Avenida Atl√¢ntica</p>
        <p>üî• Perigo agora ‚Äî Rua Esmeralda</p>
    </div>

    <div class="main-sidebar" id="sidebarMenu">
        <div class="list-group">
            <a href="{% url 'core:feed' %}" class="list-group-item">
                <span class="material-icons-outlined">dashboard</span> Feed
            </a>
            <a href="{% url 'users:perfil' %}" class="list-group-item"> 
                <span class="material-icons-outlined">person_outline</span> Perfil
            </a>
            <a href="{% url 'core:configuracao' %}" class="list-group-item">
                <span class="material-icons-outlined">settings</span> Configura√ß√µes
            </a>
            <a href="{% url 'core:suporte' %}" class="list-group-item">
                <span class="material-icons-outlined">help_outline</span> Suporte
            </a>
            <a href="{% url 'sobre_nos' %}" class="list-group-item">
                <span class="material-icons-outlined">people_outline</span> Sobre n√≥s
            </a>
            <a href="{% url 'core:tutorial' %}" class="list-group-item">
                <span class="material-icons-outlined">menu</span> Tutorial
            </a>
        </div>
        <button id="btn-close" class="sidebar-close-btn">
            <span class="material-icons-outlined">logout</span> Sair
        </button>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <nav class="main-navbar">
        <button id="menuToggleBtn"> 
            <span class="material-icons-outlined">menu</span>
        </button>

        <button class="user-profile-btn" onclick="window.location.href='{% url 'users:perfil' %}'"> 
            {% if user.foto %}
                <img src="{{ user.foto.url }}" alt="Perfil" class="profile-img" id="header-user-avatar"/>
            {% else %}
                <div class="profile-img" id="header-user-avatar" style="background-color: #ccc;"></div>
            {% endif %}
            
            <p>Ol√°, {{ user.first_name|default:'Usu√°rio' }}!</p>
        </button>

        <div class="search-area">
            <input type="text" id="searchInput" placeholder="Pesquisar cidade..." oninput="realizarBusca()" onkeypress="verificarEnter(event)" autocomplete="off"/>
            
            <button class="search-btn" onclick="buscarEIr()">
                <img src="{% static 'assets/lupa.png' %}" alt="Buscar" style="width: 20px; height: 20px;" />
            </button>
            
            <div id="suggestions" class="suggestions-box"></div>
        </div>

        <div class="notify-area">
            <button id="notifyBtn" class="notify-btn">
                <img src="{% static 'assets/Notificacao.png' %}" alt="Notifica√ß√µes"/>
            </button>
        </div>
    </nav>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-col">
                <h1 class="footer-logo">HuMap</h1>
                <p>Conectando pessoas, ideias e solu√ß√µes.</p>
            </div>
            
            <div class="footer-col">
                <h2>Navega√ß√£o</h2>
                <ul>
                    <li><a href="{% url 'core:home' %}">In√≠cio</a></li>
                    <li><a href="{% url 'sobre_nos' %}">Sobre</a></li>
                    <li><a href="{% url 'core:tutorial' %}">Tutorial</a></li>
                    <li><a href="{% url 'core:suporte' %}">Suporte</a></li>
                </ul>
            </div>
            
            <div class="footer-col">
                <h2>Contato</h2>
                <p>humap@projeto.com</p>
                <p>Recife - PE</p>
            </div>
        </div>
        
        <div class="copyright-copy">
            ¬© 2025 HuMap ‚Äî Todos os direitos reservados.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    {% block base_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- VARI√ÅVEIS ---
            const menuToggleBtn = document.getElementById("menuToggleBtn");
            const sidebarMenu = document.getElementById("sidebarMenu");
            const sidebarOverlay = document.getElementById("sidebarOverlay");
            const btnCloseSidebar = document.getElementById("btn-close");
            const notifBox = document.getElementById("notif-box");
            const notifyBtn = document.getElementById("notifyBtn");
            
            const searchInput = document.getElementById("searchInput");
            const suggestionsBox = document.getElementById("suggestions");
            let debounceTimer;

            // --- L√ìGICA DE PESQUISA (Apenas Cidade - Estado) ---
            
            window.realizarBusca = function() {
                const query = searchInput.value.trim();
                
                if (query.length < 3) {
                    suggestionsBox.style.display = 'none';
                    return;
                }

                clearTimeout(debounceTimer);
                
                debounceTimer = setTimeout(async () => {
                    suggestionsBox.style.display = 'block';
                    suggestionsBox.innerHTML = '<p style="padding:10px; color:#666;">Buscando...</p>';

                    // 1. BUSCA POR CEP
                    const cepApenasNumeros = query.replace(/\D/g, '');
                    if (cepApenasNumeros.length === 8) {
                        buscarCEP(cepApenasNumeros);
                        return;
                    }

                    // 2. BUSCA GERAL (Texto)
                    buscarTexto(query);

                }, 500);
            };

            async function buscarCEP(cep) {
                try {
                    const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await resp.json();
                    
                    if (!data.erro) {
                        // Exibe APENAS: Cidade - UF
                        const textoDisplay = `${data.localidade} - ${data.uf}`;
                        
                        suggestionsBox.innerHTML = `
                            <div class="suggestion-item" onclick="selecionarLocalPeloTexto('${textoDisplay}')">
                                <strong>üìç ${textoDisplay}</strong>
                            </div>
                        `;
                    } else {
                        suggestionsBox.innerHTML = '<p style="padding:10px;">CEP n√£o encontrado.</p>';
                    }
                } catch (e) {
                    suggestionsBox.innerHTML = '<p style="padding:10px;">Erro ao buscar CEP.</p>';
                }
            }

            async function buscarTexto(query) {
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=br&limit=5&addressdetails=1`);
                    const results = await resp.json();

                    if (results.length === 0) {
                        suggestionsBox.innerHTML = '<p style="padding:10px;">Local n√£o encontrado.</p>';
                        return;
                    }

                    // Conjunto para evitar duplicatas (ex: v√°rios bairros na mesma cidade mostrando o mesmo nome de cidade)
                    let locaisUnicos = new Set();
                    let htmlContent = '';

                    results.forEach(place => {
                        const info = formatarApenasCidade(place.address);
                        
                        // S√≥ adiciona se tiver cidade e estado e se ainda n√£o apareceu na lista
                        if (info.cidade && info.estado) {
                            const textoFinal = `${info.cidade} - ${info.estado}`;
                            
                            if (!locaisUnicos.has(textoFinal)) {
                                locaisUnicos.add(textoFinal);
                                htmlContent += `
                                    <div class="suggestion-item" onclick="selecionarCoordenadas(${place.lat}, ${place.lon}, '${textoFinal}')">
                                        <strong>üìç ${textoFinal}</strong>
                                    </div>
                                `;
                            }
                        }
                    });

                    // Se n√£o encontrou nenhuma cidade clara, usa o display_name mas tenta limpar
                    if (htmlContent === '') {
                        const place = results[0];
                        const info = formatarApenasCidade(place.address);
                        const fallbackText = (info.cidade && info.estado) ? `${info.cidade} - ${info.estado}` : "Local encontrado";
                         htmlContent = `
                            <div class="suggestion-item" onclick="selecionarCoordenadas(${place.lat}, ${place.lon}, '${fallbackText}')">
                                <strong>üìç ${fallbackText}</strong>
                            </div>
                         `;
                    }

                    suggestionsBox.innerHTML = htmlContent;

                } catch (e) {
                    console.error(e);
                    suggestionsBox.innerHTML = '<p style="padding:10px;">Erro na conex√£o.</p>';
                }
            }

            // Fun√ß√£o que extrai estritamente Cidade e Estado
            function formatarApenasCidade(address) {
                if (!address) return { cidade: '', estado: '' };
                
                // Prioridade para encontrar o nome da cidade
                const cidade = address.city || address.town || address.municipality || address.village || address.city_district || '';
                const estado = address.state || address.state_district || '';
                
                return { cidade, estado };
            }

            // --- A√á√ïES DE SELE√á√ÉO E LUPA ---

            window.buscarEIr = async function() {
                const query = searchInput.value.trim();
                if(!query) return;

                suggestionsBox.style.display = 'none';

                // Se for CEP, busca via texto gerado pelo ViaCEP
                const cepApenasNumeros = query.replace(/\D/g, '');
                if (cepApenasNumeros.length === 8) {
                     try {
                        const r = await fetch(`https://viacep.com.br/ws/${cepApenasNumeros}/json/`);
                        const d = await r.json();
                        if(!d.erro) {
                            window.selecionarLocalPeloTexto(`${d.localidade} - ${d.uf}`);
                            return;
                        }
                     } catch(e){}
                }

                // Busca direta
                const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&countrycodes=br&limit=1&addressdetails=1`);
                const data = await resp.json();

                if (data.length > 0) {
                    const place = data[0];
                    const info = formatarApenasCidade(place.address);
                    const nomeFinal = (info.cidade && info.estado) ? `${info.cidade} - ${info.estado}` : "Resultado da busca";
                    
                    window.selecionarCoordenadas(place.lat, place.lon, nomeFinal);
                } else {
                    alert("Local n√£o encontrado.");
                }
            };

            window.verificarEnter = function(e) {
                if (e.key === 'Enter') window.buscarEIr();
            };

            window.selecionarCoordenadas = function(lat, lon, nome) {
                searchInput.value = nome; // Preenche o input apenas com "Cidade - UF"
                suggestionsBox.style.display = 'none';

                if (typeof map !== 'undefined' && map) {
                    map.setView([lat, lon], 14); // Zoom
                    L.popup()
                        .setLatLng([lat, lon])
                        .setContent(`<b>${nome}</b>`)
                        .openOn(map);
                } else {
                    alert("V√° para a p√°gina inicial para ver no mapa.");
                }
            };

            window.selecionarLocalPeloTexto = async function(texto) {
                // Fun√ß√£o usada quando vem do CEP ou clique na sugest√£o
                searchInput.value = texto;
                suggestionsBox.style.display = 'none';
                
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${texto}&countrycodes=br&limit=1`);
                    const data = await resp.json();
                    
                    if (data.length > 0) {
                        window.selecionarCoordenadas(data[0].lat, data[0].lon, texto);
                    }
                } catch (e) {
                    // Silencioso ou alerta
                }
            };

            document.body.addEventListener('click', () => {
                suggestionsBox.style.display = 'none';
            });
            const searchArea = document.querySelector('.search-area');
            if (searchArea) searchArea.addEventListener('click', (e) => e.stopPropagation());

            // --- MENU LATERAL ---
            window.closeMenuNotification = function() { if (notifBox) notifBox.classList.remove("open"); }
            window.openMenu = function() {
                if (sidebarMenu) sidebarMenu.classList.add("active");
                if (sidebarOverlay) { sidebarOverlay.style.display = "block"; setTimeout(() => sidebarOverlay.classList.add("active"), 10); }
                document.body.style.overflow = "hidden";
            }
            window.closeMenu = function() {
                if (sidebarMenu) sidebarMenu.classList.remove("active");
                if (sidebarOverlay) sidebarOverlay.classList.remove("active");
                document.body.style.overflow = "";
                setTimeout(() => { if (sidebarOverlay && !sidebarMenu.classList.contains("active")) sidebarOverlay.style.display = "none"; }, 300); 
            }
            if (menuToggleBtn) menuToggleBtn.onclick = function () {
                if (sidebarMenu.classList.contains("active")) window.closeMenu();
                else { window.closeMenuNotification(); window.openMenu(); }
            };
            if (btnCloseSidebar) btnCloseSidebar.onclick = function() {
                window.closeMenu();
                setTimeout(function() { window.location.href = '{% url "users:logout" %}'; }, 100); 
            };
            if (sidebarOverlay) sidebarOverlay.addEventListener("click", window.closeMenu);
            document.querySelectorAll(".main-sidebar .list-group-item").forEach((item) => { item.addEventListener("click", window.closeMenu); });
            if (notifyBtn) notifyBtn.onclick = (e) => {
                e.stopPropagation(); window.closeMenu(); if (notifBox) notifBox.classList.toggle("open");
            };
            if (notifBox) notifBox.onclick = (e) => e.stopPropagation();
            document.body.onclick = () => { window.closeMenuNotification(); suggestionsBox.style.display = 'none'; };
        });
    </script>
    {% endblock %}
    
    {% block extra_js %}{% endblock %}

</body>
</html>